name: Build LKM for Android Kernels

on:
  workflow_dispatch:
    inputs:
      kernel_versions:
        description: '内核版本 (用逗号分隔，如: 5.10,6.1,6.6 或输入 all 编译所有版本)'
        required: true
        default: 'all'
        type: string
      module_version:
        description: '模块版本号'
        required: true
        default: '1.0.0'
        type: string

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      kernel_versions: ${{ steps.set-matrix.outputs.kernel_versions }}
      module_version: ${{ steps.set-matrix.outputs.module_version }}
    steps:
      - name: Set matrix values
        id: set-matrix
        run: |
          # 处理内核版本输入
          INPUT="${{ github.event.inputs.kernel_versions }}"
          
          if [ "$INPUT" = "all" ]; then
            # 编译所有支持的版本
            VERSIONS='["5.10","5.15","6.1","6.6","6.12"]'
            echo "✅ 将编译所有内核版本"
          else
            # 编译指定版本
            VERSIONS=$(echo "$INPUT" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "✅ 将编译指定内核版本"
          fi
          
          echo "kernel_versions=$VERSIONS" >> $GITHUB_OUTPUT
          echo "module_version=${{ github.event.inputs.module_version }}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "构建配置:"
          echo "内核版本: $VERSIONS"
          echo "模块版本: ${{ github.event.inputs.module_version }}"
          echo "架构: arm64"
  
  build:
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        kernel_version: ${{ fromJson(needs.prepare.outputs.kernel_versions) }}
    
    steps:
    - name: Checkout LKM source
      uses: actions/checkout@v4
    
    - name: Verify source structure
      run: |
        echo "检查源码结构..."
        ls -la LKM-Source/
        echo ""
        echo "源文件列表:"
        ls -lh LKM-Source/
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          git \
          wget \
          gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi
    
    - name: Setup kernel version variables
      run: |
        # 根据主版本号设置具体的内核分支
        case "${{ matrix.kernel_version }}" in
          "5.10")
            echo "KERNEL_BRANCH=android-mainline" >> $GITHUB_ENV
            echo "KERNEL_TAG=android13-5.10" >> $GITHUB_ENV
            ;;
          "5.15")
            echo "KERNEL_BRANCH=android-mainline" >> $GITHUB_ENV
            echo "KERNEL_TAG=android13-5.15" >> $GITHUB_ENV
            ;;
          "6.1")
            echo "KERNEL_BRANCH=android-mainline" >> $GITHUB_ENV
            echo "KERNEL_TAG=android14-6.1" >> $GITHUB_ENV
            ;;
          "6.6")
            echo "KERNEL_BRANCH=android-mainline" >> $GITHUB_ENV
            echo "KERNEL_TAG=android15-6.6" >> $GITHUB_ENV
            ;;
          "6.12")
            echo "KERNEL_BRANCH=android-mainline" >> $GITHUB_ENV
            echo "KERNEL_TAG=android-mainline" >> $GITHUB_ENV
            ;;
        esac
    
    - name: Cache kernel source
      id: cache-kernel
      uses: actions/cache@v4
      with:
        path: kernel-${{ matrix.kernel_version }}
        key: kernel-${{ matrix.kernel_version }}-arm64-${{ hashFiles('.github/workflows/*.yml') }}
    
    - name: Clone Android kernel source
      if: steps.cache-kernel.outputs.cache-hit != 'true'
      run: |
        git clone --depth=1 --branch=${{ env.KERNEL_TAG }} \
          https://android.googlesource.com/kernel/common \
          kernel-${{ matrix.kernel_version }}
    
    - name: Configure kernel
      run: |
        cd kernel-${{ matrix.kernel_version }}
        
        # 设置交叉编译环境
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # 使用 GKI 配置
        make gki_defconfig
        
        # 启用模块支持
        scripts/config --enable CONFIG_MODULES
        scripts/config --enable CONFIG_MODULE_UNLOAD
        scripts/config --enable CONFIG_MODVERSIONS
        
        # 准备内核构建环境
        make olddefconfig
        make modules_prepare
    
    - name: Build LKM module
      run: |
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KERNEL_DIR=$(pwd)/kernel-${{ matrix.kernel_version }}
        
        # 创建独立的构建目录
        BUILD_DIR=$(pwd)/build-${{ matrix.kernel_version }}
        mkdir -p $BUILD_DIR
        
        # 复制源码到构建目录（不修改原始源码）
        cp -r LKM-Source/* $BUILD_DIR/
        
        # 在构建目录中编译
        cd $BUILD_DIR
        make -C $KERNEL_DIR M=$(pwd) modules
        
        echo ""
        echo "✅ 编译完成，生成的模块:"
        find . -name "*.ko" -exec ls -lh {} \;
    
    - name: Prepare artifacts
      run: |
        mkdir -p output
        
        # 从构建目录复制 .ko 文件并重命名
        BUILD_DIR=$(pwd)/build-${{ matrix.kernel_version }}
        
        for ko in $(find $BUILD_DIR -name "*.ko"); do
          ko_name=$(basename "$ko")
          # 生成带版本信息的文件名: rekernel-v1.0.0-kernel6.1-arm64.ko
          new_name="${ko_name%.ko}-v${{ needs.prepare.outputs.module_version }}-kernel${{ matrix.kernel_version }}-arm64.ko"
          cp "$ko" "output/$new_name"
          echo "✅ 已生成: $new_name"
          
          # 显示模块信息
          echo ""
          echo "模块信息:"
          modinfo "$ko" || true
        done
        
        # 生成版本信息文件
        cat > output/version-kernel${{ matrix.kernel_version }}.txt << EOF
        Module Version: ${{ needs.prepare.outputs.module_version }}
        Kernel Version: ${{ matrix.kernel_version }}
        Architecture: arm64
        Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Build Workflow: ${{ github.run_number }}
        Commit SHA: ${{ github.sha }}
        Repository: ${{ github.repository }}
        EOF
        
        # 显示生成的文件
        echo ""
        echo "生成的文件列表:"
        ls -lh output/
        
        # 验证源码目录未被修改
        echo ""
        echo "验证源码目录状态:"
        git status LKM-Source/ --porcelain
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lkm-v${{ needs.prepare.outputs.module_version }}-kernel${{ matrix.kernel_version }}-arm64
        path: output/
        retention-days: 90
